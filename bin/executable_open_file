#!/usr/bin/env bash
# shellcheck disable=2155,2034
FILE_PATH=""
FILE_SIZE=0
SELECT=false

while [ "$#" -gt 0 ]; do
  case "$1" in
  -s)
    SELECT=true
    shift
    ;;
  *)
    FILE_PATH="$1"
    shift
    ;;
  esac
done

if [ "$(uname)" == "Darwin" ]; then
  FILE_SIZE=$(stat -f%z "$FILE_PATH")
elif [ "$(uname)" == "Linux" ]; then
  FILE_SIZE=$(stat --printf="%s" "$FILE_PATH")
fi

FILE_EXTENSION="${FILE_PATH##*.}"
FILE_EXTENSION_LOWER="$(printf "%s" "${FILE_EXTENSION}" | tr '[:upper:]' '[:lower:]')"
FILE_NAME="${FILE_PATH##*/}"
MIMETYPE=$(file --mime-type -Lb "${FILE_PATH}")

ipynb_glow_preview() {
  # shellcheck disable=2317
  jupyter-nbconvert "$FILE_PATH" --to markdown --stdout 2>/dev/null | glow -p && exit 0
}

open_with_chrome() {
  # shellcheck disable=2317
  open -a 'Google Chrome' "$FILE_PATH"
}

xdg_open() {
  # shellcheck disable=2317
  open "$FILE_PATH"
}

exec_command() {
  try_exec() {
    while [ "$#" -gt 0 ]; do
      $1 "$FILE_PATH"
      if [ "$?" -eq 127 ]; then
        # if this command not found, try next command
        shift
        continue
      else
        return
      fi
    done
    exit 1
  }
  if ! $SELECT; then
    try_exec "$@"
  elif [[ $# -gt 1 ]]; then
    local cmd=$(gum choose "$@")
    if [ -n "$cmd" ]; then
      $cmd "$FILE_PATH"
    fi
  else
    try_exec "$@"
  fi
  exit 0
}

handle_audio() {
  exec_command "ffplay -autoexit -nodisp" xdg_open open_with_chrome
}

handle_text() {
  exec_command "nvim" "code" "bat --paging=always"
}

handle_video() {
  exec_command xdg_open open_with_chrome
}

handle_image() {
  exec_command xdg_open open_with_chrome
}

handle_extension() {
  case "${FILE_EXTENSION_LOWER}" in
  ipynb)
    exec_command ipynb_glow_preview
    ;;
  pcm)
    exec_command "ffplay -f s16le -ar 22k -ac 1 -autoexit -nodisp"
    ;;
  ncm)
    exec_command ncmdump
    ;;
  svg)
    exec_command open_with_chrome
    ;;
  avif | bmp | gif | heic | jpeg | jpe | jpg | pgm | png | ppm | webp)
    handle_image
    ;;
  mp3 | flac | m4a | ogg | wav)
    handle_audio
    ;;
  odt | odf | ods | odp | doc | docx | xls | xlsx | ppt | pptx)
    exec_command xdg_open
    ;;
  avi | av1 | flv | mkv | m4v | mov | mp4 | webm | wmv)
    handle_video
    ;;
  esac
}

handle_mime() {
  local mimetype="${1}"

  case "${mimetype}" in

  ## Text
  text/* | */xml)
    handle_text
    ;;

  esac
}

handle_extension
MIMETYPE="$(file --dereference --brief --mime-type -- "${FILE_PATH}")"
handle_mime "${MIMETYPE}"
exec_command xdg_open
