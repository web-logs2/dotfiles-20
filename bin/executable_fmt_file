#!/usr/bin/env bash
FILE_PATH="/dev/stdin"
FILE_NAME=""
LANG=""

echo_err() {
  echo "$@" >/dev/stderr
}

while [ "$#" -gt 0 ]; do
  case "$1" in
  -l)
    shift
    LANG="$1"
    shift
    ;;
  -n)
    shift
    FILE_NAME="$1"
    shift
    ;;
  *)
    FILE_PATH="$1"
    FILE_NAME="${FILE_PATH##*/}"
    shift
    ;;
  esac
done

FILE_EXTENSION="${FILE_NAME##*.}"
FILE_EXTENSION_LOWER="$(printf "%s" "${FILE_EXTENSION}" | tr '[:upper:]' '[:lower:]')"
[[ -n $FILE_EXTENSION_LOWER ]] && [[ -z $LANG ]] && LANG="$FILE_EXTENSION_LOWER"
[[ -z $FILE_NAME ]] && [[ -n $LANG ]] && FILE_NAME="_stdin_file.$LANG"

print_fmt() {
  case "$LANG" in
  bash | sh)
    shfmt -i 2 "$FILE_PATH"
    ;;
  fish)
    fish_indent "$FILE_PATH"
    ;;
  sql)
    sql-formatter -c ~/.config/nvim/plugin_config/sql_formatter_config.json <"$FILE_PATH"
    ;;
  js | ts | jsx | tsx | mjs | mts)
    rome format --stdin-file-path="$FILE_NAME" --skip-errors --indent-style space --quote-style single <"$FILE_PATH"
    ;;
  toml)
    taplo fmt -
    ;;
  go)
    gofumpt <"$FILE_PATH" | goimports
    ;;
  vue | css | scss | less | html | jsonc | json | md | yaml | yml)
    function markdown_lint_fmt() {
      if [[ $LANG == "md" ]]; then
        local temp_path=""
        temp_path="$(mktemp)"
        cat /dev/stdin >"$temp_path"
        markdownlint -f "$temp_path"
        cat "$temp_path"
        rm "$temp_path"
      else
        cat /dev/stdin
      fi
    }
    PRETTIERD_DEFAULT_CONFIG="$HOME/.config/nvim/plugin_config/.prettierrc.yaml" prettierd "$FILE_NAME" <"$FILE_PATH" | markdown_lint_fmt
    ;;
  py | python | ipynb)
    black --stdin-filename "$FILE_NAME" --quiet - | isort --stdout --filename "$FILE_NAME" -
    ;;
  *)
    echo_err "no formatter"
    ;;
  esac
}

print_fmt